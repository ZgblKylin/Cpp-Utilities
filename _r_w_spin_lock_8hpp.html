<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cpp Utilities: include/Utilities/MemorySafety/RWSpinLock.hpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Cpp Utilities<span id="projectnumber">&#160;1.2.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="dir_cc3f469176eff71c86d2985cf9e9c60c.html">Utilities</a></li><li class="navelem"><a class="el" href="dir_24fbc3f5a90cef621dd87b410d98cd6a.html">MemorySafety</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#namespaces">Namespaces</a>  </div>
  <div class="headertitle"><div class="title">RWSpinLock.hpp File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>ReadWrite lock using spin_lock, copied from Folly library under Apache-2.0 license, see <a href="https://github.com/facebook/folly/blob/master/folly/synchronization/RWSpinLock.h">https://github.com/facebook/folly/blob/master/folly/synchronization/RWSpinLock.h</a>.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;algorithm&gt;</code><br />
<code>#include &lt;atomic&gt;</code><br />
<code>#include &lt;thread&gt;</code><br />
<code>#include &quot;<a class="el" href="_common_8h_source.html">../Common.h</a>&quot;</code><br />
</div>
<p><a href="_r_w_spin_lock_8hpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_memory_1_1_r_w_spin_lock.html">Memory::RWSpinLock</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">High-performance read-write-spinlock, see <a class="el" href="_r_w_spin_lock_8hpp.html" title="ReadWrite lock using spin_lock, copied from Folly library under Apache-2.0 license,...">RWSpinLock.hpp</a> for details.  <a href="class_memory_1_1_r_w_spin_lock.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_memory_1_1_r_w_spin_lock_1_1_read_holder.html">Memory::RWSpinLock::ReadHolder</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">RAII guard for read lock with <a class="el" href="class_memory_1_1_r_w_spin_lock.html#afd7f0984624001c03258bee4354e8388" title="SharedLockable Concept.">RWSpinLock::lock_shared()</a> on construction and <a class="el" href="class_memory_1_1_r_w_spin_lock.html#a8ce7c822fdb5e9c3b5997e77186ef2ad">RWSpinLock::unlock_shared()</a> on destruction.  <a href="class_memory_1_1_r_w_spin_lock_1_1_read_holder.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_memory_1_1_r_w_spin_lock_1_1_upgraded_holder.html">Memory::RWSpinLock::UpgradedHolder</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">RAII guard for upgrade lock with <a class="el" href="class_memory_1_1_r_w_spin_lock.html#a318a4d4b4f3dc8f6fb4d8c07f15956e7" title="UpgradeLockable Concept.">RWSpinLock::lock_upgrade()</a> on construction and <a class="el" href="class_memory_1_1_r_w_spin_lock.html#a0fefc1cc0184d89dc778b5a63903923e">RWSpinLock::unlock_upgrade()</a> on destruction.  <a href="class_memory_1_1_r_w_spin_lock_1_1_upgraded_holder.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_memory_1_1_r_w_spin_lock_1_1_write_holder.html">Memory::RWSpinLock::WriteHolder</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">RAII guard for write lock with <a class="el" href="class_memory_1_1_r_w_spin_lock.html#a8910cf79fa5d02530a57b239f15749a1" title="Lockable Concept.">RWSpinLock::lock()</a> on construction and <a class="el" href="class_memory_1_1_r_w_spin_lock.html#ae3aca9f278ce35c12300c8159e9e898e" title="Writer is responsible for clearing up both the UPGRADED and WRITER bits.">RWSpinLock::unlock()</a> on destruction.  <a href="class_memory_1_1_r_w_spin_lock_1_1_write_holder.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="namespaces" name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespace_memory"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespace_memory.html">Memory</a></td></tr>
<tr class="memdesc:namespace_memory"><td class="mdescLeft">&#160;</td><td class="mdescRight">Namespace for all classes, typedefs and functions of memory safety. See <a class="el" href="group___memory_safety.html">Memory Safety</a> for more instrucion. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >ReadWrite lock using spin_lock, copied from Folly library under Apache-2.0 license, see <a href="https://github.com/facebook/folly/blob/master/folly/synchronization/RWSpinLock.h">https://github.com/facebook/folly/blob/master/folly/synchronization/RWSpinLock.h</a>. </p>
<dl class="section author"><dt>Author</dt><dd>Xin Liu <a href="#" onclick="location.href='mai'+'lto:'+'xli'+'ux'+'@fb'+'.c'+'om'; return false;">xliux<span class="obfuscator">.nosp@m.</span>@fb.<span class="obfuscator">.nosp@m.</span>com</a></dd></dl>
<p>N.B. You most likely do <em>not</em> want to use RWSpinLock or any other kind of spinlock. Use SharedMutex instead.</p>
<p >In short, spinlocks in preemptive multi-tasking operating systems have serious problems and fast mutexes like SharedMutex are almost certainly the better choice, because letting the OS scheduler put a thread to sleep is better for system responsiveness and throughput than wasting a timeslice repeatedly querying a lock held by a thread that's blocked, and you can't prevent userspace programs blocking.</p>
<p >Spinlocks in an operating system kernel make much more sense than they do in userspace.</p>
<hr  />
<p ><b>Read-Write spin lock implementations.</b></p>
<p >Ref: <a href="http://locklessinc.com/articles/locks">http://locklessinc.com/articles/locks</a></p>
<p >Both locks here are faster than pthread_rwlock and have very low overhead (usually 20-30ns). They don't use any system mutexes and are very compact (4/8 bytes), so are suitable for per-instance based locking, particularly when contention is not expected.</p>
<p >For a spinlock, RWSpinLock is a reasonable choice. (See the note about for why a spin lock is frequently a bad idea generally.) RWSpinLock has minimal overhead, and comparable contention performance when the number of competing threads is less than or equal to the number of logical CPUs. Even as the number of threads gets larger, RWSpinLock can still be very competitive in READ, although it is slower on WRITE, and also inherently unfair to writers.</p>
<p >The lock will not grant any new shared (read) accesses while a thread attempting to acquire the lock in write mode is blocked. (That is, if the lock is held in shared mode by N threads, and a thread attempts to acquire it in write mode, no one else can acquire it in shared mode until these N threads release the lock and then the blocked thread acquires and releases the exclusive lock.) This also applies for attempts to reacquire the lock in shared mode by threads that already hold it in shared mode, making the lock non-reentrant.</p>
<p >RWSpinLock handles 2^30 - 1 concurrent readers.</p>
<hr  />
<p ><b>Benchmark on (Intel(R) Xeon(R) CPU L5630 @ 2.13GHz) 8 cores(16 HTs)</b></p>
<ol type="1">
<li>Single thread benchmark (read/write lock + unlock overhead) <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Benchmark   </th><th class="markdownTableHeadCenter">Iters   </th><th class="markdownTableHeadCenter">Total t   </th><th class="markdownTableHeadCenter">t/iter   </th><th class="markdownTableHeadCenter">iter/sec    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">* BM_RWSpinLockRead   </td><td class="markdownTableBodyCenter">100000   </td><td class="markdownTableBodyCenter">1.786 ms   </td><td class="markdownTableBodyCenter">17.86 ns   </td><td class="markdownTableBodyCenter">53.4 M    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">+30.5% BM_RWSpinLockWrite   </td><td class="markdownTableBodyCenter">100000   </td><td class="markdownTableBodyCenter">2.331 ms   </td><td class="markdownTableBodyCenter">23.31 ns   </td><td class="markdownTableBodyCenter">40.91 M    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">+ 175% BM_PThreadRWMutexRead   </td><td class="markdownTableBodyCenter">100000   </td><td class="markdownTableBodyCenter">4.917 ms   </td><td class="markdownTableBodyCenter">49.17 ns   </td><td class="markdownTableBodyCenter">19.4 M    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">+ 166% BM_PThreadRWMutexWrite   </td><td class="markdownTableBodyCenter">100000   </td><td class="markdownTableBodyCenter">4.757 ms   </td><td class="markdownTableBodyCenter">47.57 ns   </td><td class="markdownTableBodyCenter">20.05 M   </td></tr>
</table>
</li>
<li>Contention Benchmark (90% read, 10% write) <table class="doxtable">
<tr>
<th>Benchmark </th><th>hits </th><th>average </th><th>min </th><th>max </th><th>sigma  </th></tr>
<tr>
<th colspan="6">8 threads  </th></tr>
<tr>
<td>RWSpinLock Write </td><td>142666 </td><td>220 ns </td><td>78 ns </td><td>40.8 us </td><td>269 ns  </td></tr>
<tr>
<td>RWSpinLock Read </td><td>1282297 </td><td>222 ns </td><td>80 ns </td><td>37.7 us </td><td>248 ns  </td></tr>
<tr>
<td>pthread_rwlock_t Write </td><td>84248 </td><td>2.48 us </td><td>99 ns </td><td>269 us </td><td>8.19 us  </td></tr>
<tr>
<td>pthread_rwlock_t Read </td><td>761646 </td><td>933 ns </td><td>101 ns </td><td>374 us </td><td>3.25 us  </td></tr>
<tr>
<th colspan="6">16 threads  </th></tr>
<tr>
<td>RWSpinLock Write </td><td>124236 </td><td>237 ns </td><td>78 ns </td><td>261 us </td><td>801 ns  </td></tr>
<tr>
<td>RWSpinLock Read </td><td>1115807 </td><td>236 ns </td><td>78 ns </td><td>2.27 ms </td><td>2.17 us  </td></tr>
<tr>
<td>pthread_rwlock_t Write </td><td>83363 </td><td>7.12 us </td><td>99 ns </td><td>785 us </td><td>28.1 us  </td></tr>
<tr>
<td>pthread_rwlock_t Read </td><td>754978 </td><td>2.18 us </td><td>101 ns </td><td>1.02 ms </td><td>14.3 us  </td></tr>
<tr>
<th colspan="6">50 threads  </th></tr>
<tr>
<td>RWSpinLock Write </td><td>131142 </td><td>1.37 us </td><td>82 ns </td><td>7.53 ms </td><td>68.2 us  </td></tr>
<tr>
<td>RWSpinLock Read </td><td>1181240 </td><td>262 ns </td><td>78 ns </td><td>6.62 ms </td><td>12.7 us  </td></tr>
<tr>
<td>pthread_rwlock_t Write </td><td>80849 </td><td>112 us </td><td>103 ns </td><td>4.52 ms </td><td>263 us  </td></tr>
<tr>
<td>pthread_rwlock_t Read </td><td>728698 </td><td>24 us </td><td>101 ns </td><td>7.28 ms </td><td>194 us  </td></tr>
</table>
</li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
